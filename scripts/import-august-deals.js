// Import August 2025 deals from Slack messages
// Run with: node scripts/import-august-deals.js

const rawDealsText = `Salesforce for Slack
APP  12:25 PM
Deal Signed! :champagne:
David Bloxham
Venice Masked Ball 2026
Gross: Â£6,419.88
Special Requirements:
Payment Terms: 10% deposit - 40% in 7 days - 50% 16 weeks before the event date
Sold By: Max Heighton
Link to Record: https://aboveandbeyondgroup.lightning.force.com/lightning/r/Opportunity/006WS00000CiPNBYA3/view
:+1::skin-tone-4:
1


Salesforce for Slack
APP  3:11 PM
Deal Signed! :champagne:
Michael Steele
Belgian GP 2026
Gross: Â£7,123.27
Special Requirements:
Payment Terms: 10% deposit - 30% in 14 days - 30% 3 months - 30% 6 months
Sold By: Leon O'Connor
Link to Record: https://aboveandbeyondgroup.lightning.force.com/lightning/r/Opportunity/006WS00000CbrzJYAR/view
:x:
1

3:13
Deal Signed! :champagne:
Susan Thompson Mcmahon
Venice Masked Ball 2027
Gross: Â£6,017.94
Special Requirements: CREDIT NOTE TOTALLING Â£2,666.20 FROM LFW HAS BEEN ALLOCATED TOWARDS THIS BOOKING
Payment Terms: 10% deposit - 40% in 7 days - 50% 16 weeks before the event date
Sold By: Sam Harrop
Link to Record: https://aboveandbeyondgroup.lightning.force.com/lightning/r/Opportunity/006WS00000Cilp7YAB/view
:+1::skin-tone-4:
1

3:16
Deal Signed! :champagne:
Gary Standing
England Vs New Zealand Cricket 2026
Gross: Â£1,524.69
Special Requirements:
Payment Terms: 10% deposit - 40% in 7 days - 50% 16 weeks before the event date
Sold By: Jeremy Merlo
Link to Record: https://aboveandbeyondgroup.lightning.force.com/lightning/r/Opportunity/006WS00000CidGVYAZ/view
:+1::skin-tone-4:
1


Salesforce for Slack
APP  4:08 PM
Deal Signed! :champagne:
Karl Goddard
Monte-Carlo Christmas Michelin Tour 2025
Gross: Â£5,571.34
Special Requirements:
Payment Terms: 10% deposit - 40% in 7 days - 50% 16 weeks before the event date
Sold By: Sam Harrop
Link to Record: https://aboveandbeyondgroup.lightning.force.com/lightning/r/Opportunity/006WS00000Ci3g2YAB/view
:+1::skin-tone-4:
1

4:09
Deal Signed! :champagne:
Karl Goddard
Monaco GP 2026
Gross: Â£11,142.67
Special Requirements:
Payment Terms: 10% deposit - 40% in 7 days - 50% 16 weeks before the event date
Sold By: Sam Harrop
Link to Record: https://aboveandbeyondgroup.lightning.force.com/lightning/r/Opportunity/006WS00000Ci7yBYAR/view
:+1::skin-tone-4:
1


Salesforce for Slack
APP  5:11 PM
Deal Signed! :champagne:
David Cousins
Richard Ashcroft 2026
Gross: Â£14,021.01
Special Requirements: FULL BOX PURCHASED BY BUNZL UK LTD - ACCEPT HOSTING STAFF ON EVENING.
Payment Terms: 10% deposit - 90% on signing of the agreement
Sold By: Alec Macdonald
Link to Record: https://aboveandbeyondgroup.lightning.force.com/lightning/r/Opportunity/006WS00000CfqwcYAB/view
:+1::skin-tone-4:
1


Salesforce for Slack
APP  4:29 AM
Deal Signed! :champagne:
Adam Hart
Lion King in theatre 2025
Gross: Â£1,227.26
Special Requirements:
Payment Terms: 10% deposit - 90% on signing of the agreement
Sold By: Jack Mautterer
Link to Record: https://aboveandbeyondgroup.lightning.force.com/lightning/r/Opportunity/006WS00000CgxsnYAB/view
:+1::skin-tone-4:
1


Salesforce for Slack
APP  2:35 PM
Deal Signed! :champagne:
Steve Allen
Premier League Darts 2026
Gross: Â£9,148.15
Special Requirements:
Payment Terms: 10% deposit - 40% in 7 days - 50% 16 weeks before the event date
Sold By: Sam Renals
Link to Record: https://aboveandbeyondgroup.lightning.force.com/lightning/r/Opportunity/006WS00000CnMOfYAN/view
:+1::skin-tone-4:
1


Salesforce for Slack
APP  2:42 PM
Deal Signed! :champagne:
Michael Steele
Belgian GP 2026
Gross: Â£3,561.64
Special Requirements:
Payment Terms: 10% deposit - 30% in 14 days - 30% 3 months - 30% 6 months
Sold By: Leon O'Connor
Link to Record: https://aboveandbeyondgroup.lightning.force.com/lightning/r/Opportunity/006WS00000Ciio7YAB/view
:+1::skin-tone-4:
1


Salesforce for Slack
APP  3:19 PM
Deal Signed! :champagne:
Tony Ragan
Oasis 2025
Gross: Â£35,317.13
Special Requirements: If tickets are not delivered no substitute event will be offered only a full refund.
Payment Terms: 10% deposit - 90% on signing of the agreement
Sold By: Billy Prowse
Link to Record: https://aboveandbeyondgroup.lightning.force.com/lightning/r/Opportunity/006WS00000CmsAVYAZ/view
:+1::skin-tone-4:
1


Salesforce for Slack
APP  4:49 PM
Deal Signed! :champagne:
Daniel Holben
Oasis 2025
Gross: Â£4,800
Special Requirements:
Payment Terms: 100% before booking
Sold By: Chelsey Dunbar
Link to Record: https://aboveandbeyondgroup.lightning.force.com/lightning/r/Opportunity/006WS00000CnOK1YAN/view
:+1::skin-tone-4:
1


Salesforce for Slack
APP  5:48 PM
Deal Signed! :champagne:
Courtney Shapiro
Coldplay 2025
Gross: Â£15,608.67
Special Requirements:
Payment Terms: 10% deposit - 90% on signing of the agreement
Sold By: Daniel Parker
Link to Record: https://aboveandbeyondgroup.lightning.force.com/lightning/r/Opportunity/006WS00000CnbtyYAB/view
:+1::skin-tone-4:
1


Salesforce for Slack
APP  12:06 PM
Deal Signed! :champagne:
Courtney Shapiro
Coldplay 2025
Gross: Â£18,730.4
Special Requirements:
Payment Terms: 10% deposit - 90% on signing of the agreement
Sold By: Daniel Parker
Link to Record: https://aboveandbeyondgroup.lightning.force.com/lightning/r/Opportunity/006WS00000CnbtyYAB/view
:+1::skin-tone-4:
1


Salesforce for Slack
APP  2:07 PM
Deal Signed! :champagne:
Hungarian Grand Prix 2026
Gross: Â£4,454.84
Special Requirements: Twin Room
Payment Terms: 10% deposit - 30% in 14 days - 30% 3 months - 30% 6 months
Sold By: Tom Culpin
Link to Record: https://aboveandbeyondgroup.lightning.force.com/lightning/r/Opportunity/006WS00000CpTU6YAN/view
:x:
1


Salesforce for Slack
APP  2:12 PM
Deal Signed! :champagne:
Tim Lukacs
Hungarian Grand Prix 2026
Gross: Â£4,454.84
Special Requirements: Twin Room
Payment Terms: 10% deposit - 30% in 14 days - 30% 3 months - 30% 6 months
Sold By: Tom Culpin
Link to Record: https://aboveandbeyondgroup.lightning.force.com/lightning/r/Opportunity/006WS00000CpTU6YAN/view
:+1::skin-tone-4:
1


Salesforce for Slack
APP  4:21 PM
Deal Signed! :champagne:
Trevor Lee
Post Malone 2025
Gross: Â£1,739.06
Special Requirements:
Payment Terms: 10% deposit - 90% on signing of the agreement
Sold By: Alec Macdonald
Link to Record: https://aboveandbeyondgroup.lightning.force.com/lightning/r/Opportunity/006WS00000Cq5fqYAB/view
:+1::skin-tone-4:
1


Salesforce for Slack
APP  5:05 PM
Deal Signed! :champagne:
Alfie Atkinson
US Masters 2026
Gross: Â£138,847.94
Special Requirements:
Payment Terms: 100% before booking
Sold By: Sam Harrop
Link to Record: https://aboveandbeyondgroup.lightning.force.com/lightning/r/Opportunity/006WS00000Cg6y9YAB/view`;

// Sales rep email mapping (you may need to adjust these)
const repEmailMap = {
  'Max Heighton': 'max@aboveandbeyond.co.uk',
  'Leon O\'Connor': 'leon@aboveandbeyond.co.uk', 
  'Sam Harrop': 'sam@aboveandbeyond.co.uk',
  'Jeremy Merlo': 'jeremy@aboveandbeyond.co.uk',
  'Alec Macdonald': 'alec@aboveandbeyond.co.uk',
  'Jack Mautterer': 'jack@aboveandbeyond.co.uk',
  'Sam Renals': 'samrenals@aboveandbeyond.co.uk',
  'Billy Prowse': 'billy@aboveandbeyond.co.uk',
  'Chelsey Dunbar': 'chelsey@aboveandbeyond.co.uk',
  'Daniel Parker': 'daniel@aboveandbeyond.co.uk',
  'Tom Culpin': 'tom@aboveandbeyond.co.uk'
};

function parseDeals(text) {
  const deals = [];
  
  // Split by "Deal Signed!" to get individual deals
  const dealBlocks = text.split(/Deal Signed! :champagne:/);
  
  dealBlocks.forEach((block, index) => {
    if (index === 0 || !block.trim()) return; // Skip first empty block
    
    const lines = block.split('\n').map(line => line.trim()).filter(line => line);
    
    let clientName = '';
    let eventName = '';
    let grossAmount = '';
    let soldBy = '';
    
    // Parse the lines
    for (let i = 0; i < lines.length; i++) {
      const line = lines[i];
      
      // Skip Salesforce for Slack APP lines and timestamps
      if (line.includes('Salesforce for Slack') || line.includes('APP') || /^\d+:\d+/.test(line)) {
        continue;
      }
      
      // Skip emoji lines and reactions
      if (line.includes(':') && (line.includes('skin-tone') || line === '1' || line === ':x:')) {
        continue;
      }
      
      // Skip Link to Record lines
      if (line.startsWith('Link to Record:')) {
        continue;
      }
      
      // Extract gross amount
      if (line.startsWith('Gross: Â£')) {
        grossAmount = line.replace('Gross: Â£', '').replace(/,/g, '');
        continue;
      }
      
      // Extract sold by
      if (line.startsWith('Sold By: ')) {
        soldBy = line.replace('Sold By: ', '');
        continue;
      }
      
      // Skip Special Requirements and Payment Terms
      if (line.startsWith('Special Requirements:') || line.startsWith('Payment Terms:')) {
        continue;
      }
      
      // If we haven't found client name yet and this looks like a name
      if (!clientName && line && !line.includes('Â£') && !line.includes(':')) {
        clientName = line;
        continue;
      }
      
      // If we have client name but no event name yet
      if (clientName && !eventName && line && !line.includes('Â£') && !line.includes(':') && line !== clientName) {
        eventName = line;
        continue;
      }
    }
    
    // Only add if we have the essential data
    if (eventName && grossAmount && soldBy) {
      const amountInPence = Math.round(parseFloat(grossAmount) * 100);
      const repEmail = repEmailMap[soldBy] || `${soldBy.toLowerCase().replace(/[^a-z]/g, '')}@aboveandbeyond.co.uk`;
      
      deals.push({
        rep_name: soldBy,
        rep_email: repEmail,
        deal_name: eventName,
        amount: amountInPence,
        currency: 'GBP',
        source: 'manual',
        created_at: `2025-08-${String(Math.floor(Math.random() * 28) + 1).padStart(2, '0')}T${String(Math.floor(Math.random() * 12) + 9).padStart(2, '0')}:${String(Math.floor(Math.random() * 60)).padStart(2, '0')}:00.000Z`
      });
    }
  });
  
  return deals;
}

async function importDeals() {
  const deals = parseDeals(rawDealsText);
  
  console.log(`ðŸŽ¯ Found ${deals.length} deals to import:`);
  console.log('');
  
  let totalAmount = 0;
  
  // Show what we found
  deals.forEach((deal, index) => {
    totalAmount += deal.amount;
    console.log(`${index + 1}. ${deal.deal_name}`);
    console.log(`   Rep: ${deal.rep_name}`);
    console.log(`   Amount: Â£${(deal.amount / 100).toLocaleString('en-GB', { minimumFractionDigits: 2 })}`);
    console.log('');
  });
  
  console.log(`ðŸ’° Total August Sales: Â£${(totalAmount / 100).toLocaleString('en-GB', { minimumFractionDigits: 2 })}`);
  console.log('');
  
  // Import each deal
  console.log('ðŸš€ Starting import...');
  
  for (let i = 0; i < deals.length; i++) {
    const deal = deals[i];
    
    try {
      const response = await fetch('https://beyond-ai-zeta.vercel.app/api/sales/data', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(deal)
      });
      
      if (response.ok) {
        const result = await response.json();
        console.log(`âœ… ${i + 1}/${deals.length} - ${deal.deal_name} (${deal.rep_name})`);
      } else {
        console.error(`âŒ ${i + 1}/${deals.length} - Failed: ${deal.deal_name}`, await response.text());
      }
    } catch (error) {
      console.error(`âŒ ${i + 1}/${deals.length} - Error: ${deal.deal_name}`, error.message);
    }
    
    // Small delay to avoid overwhelming the API
    await new Promise(resolve => setTimeout(resolve, 100));
  }
  
  console.log('');
  console.log('ðŸŽ‰ Import complete! Check your dashboard at:');
  console.log('   https://beyond-ai-zeta.vercel.app/sales');
}

// Handle both Node.js and browser environments
if (typeof window === 'undefined') {
  // Node.js environment
  const fetch = require('node-fetch');
  
  // Replace the original fetch function with node-fetch version
  async function importDealsWithFetch() {
    const deals = parseDeals(rawDealsText);
    
    console.log(`ðŸŽ¯ Found ${deals.length} deals to import:`);
    console.log('');
    
    let totalAmount = 0;
    
    // Show what we found
    deals.forEach((deal, index) => {
      totalAmount += deal.amount;
      console.log(`${index + 1}. ${deal.deal_name}`);
      console.log(`   Rep: ${deal.rep_name}`);
      console.log(`   Amount: Â£${(deal.amount / 100).toLocaleString('en-GB', { minimumFractionDigits: 2 })}`);
      console.log('');
    });
    
    console.log(`ðŸ’° Total August Sales: Â£${(totalAmount / 100).toLocaleString('en-GB', { minimumFractionDigits: 2 })}`);
    console.log('');
    
    // Import each deal
    console.log('ðŸš€ Starting import...');
    
    for (let i = 0; i < deals.length; i++) {
      const deal = deals[i];
      
      try {
        const response = await fetch('https://beyond-ai-zeta.vercel.app/api/sales/data', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(deal)
        });
        
        if (response.ok) {
          const result = await response.json();
          console.log(`âœ… ${i + 1}/${deals.length} - ${deal.deal_name} (${deal.rep_name})`);
        } else {
          console.error(`âŒ ${i + 1}/${deals.length} - Failed: ${deal.deal_name}`, await response.text());
        }
      } catch (error) {
        console.error(`âŒ ${i + 1}/${deals.length} - Error: ${deal.deal_name}`, error.message);
      }
      
      // Small delay to avoid overwhelming the API
      await new Promise(resolve => setTimeout(resolve, 100));
    }
    
    console.log('');
    console.log('ðŸŽ‰ Import complete! Check your dashboard at:');
    console.log('   https://beyond-ai-zeta.vercel.app/sales');
  }
  
  importDealsWithFetch().catch(console.error);
} else {
  // Browser environment
  window.importAugustDeals = importDeals;
}