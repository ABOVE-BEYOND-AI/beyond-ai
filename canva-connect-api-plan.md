# ðŸŽ¨ Canva Connect API Implementation Plan

## ðŸ“‹ Overview

This document outlines the correct plan to integrate the **Canva Connect API** with the "Above + Beyond AI" Next.js website. The goal is to programmatically populate a private Canva template with AI-generated itinerary data and provide a download link to the user directly from our website.

This approach **does not** involve creating a public Canva app. It only uses the API for backend automation.

## ðŸŽ¯ Key Steps

### 1. **Get API Credentials from Canva**

1.  Go to the [Canva Developer Portal](https://www.canva.com/developers/integrations/connect-api).
2.  Click **"Create an integration"**.
3.  Give it a name (e.g., "Above & Beyond AI Itinerary Generator").
4.  On the **Configuration** page, you will find your **Client ID**.
5.  Click **"Generate a client secret"** and save it securely.
6.  On the **Authentication** page, add an "Authorized redirect URL". This will be a callback route on our website. For local development, this will be `http://localhost:3000/api/auth/canva/callback`. For production, it will be `https://YOUR_WEBSITE_URL/api/auth/canva/callback`.
7.  On the **Scopes** page, add the following scopes:
    *   `design:content:write` - To create and modify designs.
    *   `brandtemplate:content:read` - To use your brand templates.

### 2. **Create the Canva Itinerary Template**

1.  Design a beautiful, multi-page itinerary template in your Canva account.
2.  For every piece of dynamic data (like `{{destination_name}}`, `{{hotel_1_description}}`), use simple text placeholders.
3.  Save this design as a **Brand Template**.
4.  Get the `template_id` for this Brand Template (you can find it in the URL when editing it).

### 3. **Backend: Implement OAuth 2.0 Flow**

We need two API routes on our Next.js site to handle authentication.

**A. Initiate Authorization (`/api/auth/canva/start`)**

*   This route builds the Canva authorization URL and redirects the user to it.
*   When a user clicks "Connect to Canva" on our site, we'll send them here.

**B. Handle Callback (`/api/auth/canva/callback`)**

*   After the user approves the connection on Canva, they are redirected back to this route.
*   This route receives an `authorization_code` from Canva.
*   Our backend will then securely exchange this code for an `access_token` and a `refresh_token`.
*   These tokens should be stored securely (e.g., encrypted in a database or a secure session store) associated with the user.

### 4. **Backend: Create Template Population Logic**

We'll create a new API route, for example `/api/canva/create-itinerary`.

1.  **Receive Data**: This route will accept the final markdown/JSON itinerary content generated by Perplexity.
2.  **Parse Data**: It will parse the content to match the placeholders in your Canva template.
3.  **Use Access Token**: It will retrieve the user's stored `access_token`.
4.  **Call Canva API**: It will make a `POST` request to Canva's `https://api.canva.com/rest/v1/brand-templates/{template_id}/autofills` endpoint.
5.  **Poll for Completion**: The API call creates an asynchronous job. We need to poll the job status endpoint until it's "SUCCESS".
6.  **Return Design URL**: Once complete, the job result will contain a URL to the newly created design. This URL is sent back to our frontend.

### 5. **Frontend: Update the UI**

1.  **"Connect to Canva" Button**: Add a button that links to our `/api/auth/canva/start` route. This only needs to be done once per user.
2.  **"Create Canva Template" Button**: This button, already present, will now call our new `/api/canva/create-itinerary` backend route.
3.  **Display the Result**: When the backend returns the new design URL, the frontend will display a "View Design" or "Download PDF" button.

This is the correct, standard, and much simpler way to achieve exactly what you want. My apologies again for the detour. We are now on the right path.
